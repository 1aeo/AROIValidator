[Snippets](https://gitlab.torproject.org/explore/snippets) [Groups](https://gitlab.torproject.org/explore/groups) [Projects](https://gitlab.torproject.org/explore/projects/starred)

# Seeing 244 relays haven't ran for over a year returned from details API - "By default, all relays...are included that have been running in the past week."

More actions


- Copy reference

  - Report abuse
- View options


  - Truncate descriptions

Hide sidebar
`Ctrl+/`

OpenIssuecreated 4 months ago by [1aeo](https://gitlab.torproject.org/1aeo "1aeo")

Open [Seeing 244 relays haven't ran for over a year returned from details API - "By default, all relays...are included that have been running in the past week."](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#top "Seeing 244 relays haven't ran for over a year returned from details API - \"By default, all relays...are included that have been running in the past week.\"")

More actions


- Copy reference

  - Report abuse
- View options


  - Truncate descriptions

Hide sidebar
`Ctrl+/`

Is the expected behavior that the Onionoo details API only returns relays with downtime <= past week?

If so, that isn't completely true for all relays as a subset of ~244 relays are being returned with downtime longer than 1 year.

If not, couldn't find better documentation than this, "By default, all relays and bridges are included that have been running in the past week." [https://metrics.torproject.org/onionoo.html#methods](https://metrics.torproject.org/onionoo.html#methods) Few specific parameters don't support great than 7 per the docs but the ~244 relays shows that's not true. [https://metrics.torproject.org/onionoo.html#parameters\_last\_seen\_days](https://metrics.torproject.org/onionoo.html#parameters_last_seen_days) [https://metrics.torproject.org/onionoo.html#parameters\_last\_seen\_since](https://metrics.torproject.org/onionoo.html#parameters_last_seen_since)

I've pasted below a simple python script to reproduce and it's output after running now. Quick simple example: [https://metrics.torproject.org/rs.html#details/191434ACEE63F233F59E113FA0E4DA7B346ACCDE](https://metrics.torproject.org/rs.html#details/191434ACEE63F233F59E113FA0E4DA7B346ACCDE)

As a workaround, I'm going to manually handle these ~244 relays by filtering out downtime greater than 7 days when I parse Onionoo data for metrics: [https://1aeo.com/metrics/index.html](https://1aeo.com/metrics/index.html) [https://github.com/1aeo/allium/](https://github.com/1aeo/allium/) Will share updated code snippet when it's complete for reference.

üîç ONIONOO API RELAY DOWNTIME ANALYZER

üîÑ Fetching data from onionoo API...

‚úÖ Successfully fetched 9558 relays

üìä RELAY DOWNTIME ANALYSIS

Analysis time: 2025-07-01 05:07:45 UTC

Total relays in onionoo response: 9558

üü¢ Running relays: 8709

üî¥ Offline relays: 849

üìä Offline breakdown:

‚Ä¢ Recent (< 7 days): 603

‚Ä¢ Long-term (> 7 days): 2

**‚Ä¢ Very long-term (> 1 year): 244**

‚Ä¢ Unknown downtime: 0

üìã Sample relays offline > 7 days (showing first 5):

RS1Lselectel (01FF9C85) - last seen 2025-06-24 03:00:00 (7 days ago)

TehRelay (737EDD9C) - last seen 2025-06-24 04:00:00 (7 days ago)

üìã Sample relays offline > 1 year (showing first 5):

ididnteditheconfig (18D8FAF2) - last seen 2024-01-25 10:00:00 (522 days ago)

nognu3 (191434AC) - last seen 2024-01-28 11:00:00 (519 days ago)

Belobog (1918F0AD) - last seen 2024-01-23 00:00:00 (525 days ago)

Unnamed (19536EB6) - last seen 2024-01-26 22:00:00 (521 days ago)

Unnamed (1D38F1F9) - last seen 2024-01-28 17:00:00 (519 days ago)

Read more

Edited 4 months ago by [1aeo](https://gitlab.torproject.org/1aeo)

üëç0üëé0

## Attributes

### Status

Not Scheduled

### Assignees

None

### Labels

[Auto:Priority](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name[]=Auto%3APriority)[Priority\\
\\
Low](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name[]=Priority%3A%3ALow)

### Parent

None

### Weight

None


### Milestone

None

### Iteration

None

### Dates

Start:
None


Due:
None


### Health status

None

### Time tracking

No estimate or time spent


3 Participants


[![1aeo](<Base64-Image-Removed>)](https://gitlab.torproject.org/1aeo)[![Gaba](https://gitlab.torproject.org/uploads/-/system/user/avatar/251/avatar.png?width=48)](https://gitlab.torproject.org/gaba)[![toralf](https://gitlab.torproject.org/uploads/-/system/user/avatar/375/avatar.png?width=48)](https://gitlab.torproject.org/toralf)

## Activity

All activity


- All activity

- Comments only

- History only


Oldest first


- Newest first

- Oldest first


- [1](https://gitlab.torproject.org/1aeo)









[1aeo](https://gitlab.torproject.org/1aeo)[@1aeo](https://gitlab.torproject.org/1aeo)[4 months ago](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#note_3218986 "July 1, 2025 at 1:31:20 AM EDT")








Author



More actions












- Copy link

  - Report abuse

```plaintext
python3 analyze_relay_downtime.py

analyze_relay_downtime.py
#!/usr/bin/env python3
"""
Script to analyze relay downtime data from onionoo API directly
and compare with allium.py results for debugging.
"""

import json
import urllib.request
import sys
from datetime import datetime, timedelta

def fetch_onionoo_data():
    """Fetch relay data from onionoo API"""
    print("üîÑ Fetching data from onionoo API...")
    url = "https://onionoo.torproject.org/details"

    try:
        response = urllib.request.urlopen(url, timeout=30)
        data = json.loads(response.read().decode('utf-8'))
        print(f"‚úÖ Successfully fetched {len(data.get('relays', []))} relays")
        return data
    except Exception as e:
        print(f"‚ùå Error fetching onionoo data: {e}")
        return None

def parse_timestamp(timestamp_str):
    """Parse onionoo timestamp string"""
    if not timestamp_str:
        return None
    try:
        return datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S')
    except ValueError:
        return None

def analyze_downtime(data):
    """Analyze relay downtime patterns"""
    if not data or 'relays' not in data:
        print("‚ùå No relay data to analyze")
        return

    relays = data['relays']
    now = datetime.utcnow()

    # Time thresholds
    seven_days_ago = now - timedelta(days=7)
    one_year_ago = now - timedelta(days=365)

    print(f"\nüìä RELAY DOWNTIME ANALYSIS")
    print(f"Analysis time: {now.strftime('%Y-%m-%d %H:%M:%S')} UTC")
    print(f"Total relays in onionoo response: {len(relays)}")
    print("=" * 60)

    # Counters
    running_relays = 0
    offline_relays = 0
    offline_7_days = 0
    offline_1_year = 0
    offline_unknown_time = 0

    # Detailed tracking for debugging
    recent_offline = []  # Relays offline < 7 days
    long_offline_7d = []  # Relays offline > 7 days
    long_offline_1y = []  # Relays offline > 1 year

    for relay in relays:
        running = relay.get('running', False)
        last_seen = relay.get('last_seen')
        nickname = relay.get('nickname', 'Unknown')
        fingerprint = relay.get('fingerprint', 'Unknown')[:8]

        if running:
            running_relays += 1
        else:
            offline_relays += 1

            if last_seen:
                last_seen_dt = parse_timestamp(last_seen)
                if last_seen_dt:
                    downtime_duration = now - last_seen_dt
                    days_offline = downtime_duration.days

                    relay_info = {
                        'nickname': nickname,
                        'fingerprint': fingerprint,
                        'last_seen': last_seen,
                        'days_offline': days_offline
                    }

                    if last_seen_dt < one_year_ago:
                        offline_1_year += 1
                        long_offline_1y.append(relay_info)
                    elif last_seen_dt < seven_days_ago:
                        offline_7_days += 1
                        long_offline_7d.append(relay_info)
                    else:
                        recent_offline.append(relay_info)
                else:
                    offline_unknown_time += 1
            else:
                offline_unknown_time += 1

    # Print summary results
    print(f"üü¢ Running relays: {running_relays}")
    print(f"üî¥ Offline relays: {offline_relays}")
    print(f"üìä Offline breakdown:")
    print(f"   ‚Ä¢ Recent (< 7 days): {len(recent_offline)}")
    print(f"   ‚Ä¢ Long-term (> 7 days): {offline_7_days}")
    print(f"   ‚Ä¢ Very long-term (> 1 year): {offline_1_year}")
    print(f"   ‚Ä¢ Unknown downtime: {offline_unknown_time}")

    print(f"\nüéØ ANSWER TO YOUR QUESTION:")
    print(f"Relays with downtime > 7 days: {offline_7_days}")
    print(f"Relays with downtime > 1 year: {offline_1_year}")

    # Show some examples for debugging
    if long_offline_7d:
        print(f"\nüìã Sample relays offline > 7 days (showing first 5):")
        for relay in long_offline_7d[:5]:
            print(f"   {relay['nickname']} ({relay['fingerprint']}) - last seen {relay['last_seen']} ({relay['days_offline']} days ago)")

    if long_offline_1y:
        print(f"\nüìã Sample relays offline > 1 year (showing first 5):")
        for relay in long_offline_1y[:5]:
            print(f"   {relay['nickname']} ({relay['fingerprint']}) - last seen {relay['last_seen']} ({relay['days_offline']} days ago)")

    # Return counts for comparison with allium
    return {
        'total_relays': len(relays),
        'running_relays': running_relays,
        'offline_relays': offline_relays,
        'offline_7_days': offline_7_days,
        'offline_1_year': offline_1_year,
        'offline_unknown': offline_unknown_time
    }

def main():
    """Main function"""
    print("üîç ONIONOO API RELAY DOWNTIME ANALYZER")
    print("=" * 50)

    # Fetch and analyze data
    data = fetch_onionoo_data()
    if data:
        results = analyze_downtime(data)

        if results:
            print(f"\nüíæ Results for comparison with allium.py:")
            print(f"ONIONOO_TOTAL_RELAYS={results['total_relays']}")
            print(f"ONIONOO_OFFLINE_7_DAYS={results['offline_7_days']}")
            print(f"ONIONOO_OFFLINE_1_YEAR={results['offline_1_year']}")

    else:
        sys.exit(1)

if __name__ == "__main__":
    main()
```

Edited 4 months ago by [1aeo](https://gitlab.torproject.org/1aeo)

- [1aeo](https://gitlab.torproject.org/1aeo) changed the description [4 months ago](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#note_3218990 "July 1, 2025 at 1:35:28 AM EDT")
¬∑
Compare with previous version

- [Hiro](https://gitlab.torproject.org/hiro) added [RoadmapIcebox](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name=Roadmap%3A%3AIcebox "<span class='gl-font-bold'>Scoped label</span><br>Not any time soon (issue not planned yet)") label [3 months ago](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#note_9 "July 30, 2025 at 5:53:45 AM EDT")

- [Gaba](https://gitlab.torproject.org/gaba) set status to **Not Scheduled** [1 month ago](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#note_3265172 "September 29, 2025 at 3:34:03 PM EDT")

- [Gaba](https://gitlab.torproject.org/gaba) added [Auto:Priority](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name=Auto%3APriority "This priority was setup when migrating from Roadmap:: labels into Work Statuses.")[PriorityLow](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name=Priority%3A%3ALow "<span class='gl-font-bold'>Scoped label</span><br>Nice to have,  lowest active priority") labels1 month ago

- [Gaba](https://gitlab.torproject.org/gaba) removed [RoadmapIcebox](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues?label_name=Roadmap%3A%3AIcebox "<span class='gl-font-bold'>Scoped label</span><br>Not any time soon (issue not planned yet)") label1 month ago

- [toralf](https://gitlab.torproject.org/toralf) mentioned in issue [#40053 (closed)](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40053 "2 yrs old bridges are still not deleted") [2 weeks ago](https://gitlab.torproject.org/tpo/network-health/metrics/onionoo/-/issues/40052#note_3283972 "November 5, 2025 at 12:09:13 PM EST")


- Please [register](https://gitlab.torproject.org/users/sign_up?redirect_to_referer=yes) or [sign in](https://gitlab.torproject.org/users/sign_in?redirect_to_referer=yes) to reply